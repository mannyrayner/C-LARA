{
  "clara_app/export_zipfile_views.py": [
    {
      "created_at": "2025-12-22T09:35:52.835915+00:00",
      "model": "gpt-5.2",
      "usage": {
        "model": "gpt-5.2",
        "prompt_tokens": 5529,
        "completion_tokens": 885,
        "total_tokens": 6414,
        "estimated_cost_usd": 0.022065750000000002
      },
      "analysis": {
        "proposed_docstring": "Views for exporting C-LARA data into portable filesystem bundles.\n\nThis module implements three export workflows:\n\n1) Single-project export (role-guarded): starts an async Django-Q task to build a project export zip via clara_export_import.make_export_zipfile_internal, streams progress through the task-update mechanism (make_asynch_callback_and_report_id + post_task_update), exposes a JSON polling endpoint for the browser, and renders monitor/complete pages. When S3-backed storage is enabled, the completion view can return a presigned download URL for the generated zip path.\n\n2) Bulk export of project source zips (admin-only): enqueues an async task that iterates over CLARAProject rows (optionally filtered by only_ids/skip_ids), writes one subdirectory per project under a destination root, copies the generated source zip into <project_id>/source.zip, and writes per-project metadata plus batch-level index.json and failures.json.\n\n3) Bulk export of audio repository content (admin-only): enqueues an async task that walks AudioMetadata rows (optionally filtered by engine/language/voice), copies referenced audio files into an output tree grouped by engine_id/language_id/voice_id, and writes a manifest.json per group plus batch-level index.json and failures.json.\n\nAll long-running work is performed in background tasks and reported to the UI via TaskUpdate polling endpoints; monitor templates are expected to poll the corresponding *_status views until a terminal marker (\"finished\" or \"error\") is observed.",
        "short_summary": "This module provides Django views to export C-LARA projects and audio assets into portable bundles on disk. It supports a role-protected single-project export zip workflow and two admin-only bulk export workflows (project source zips and audio repository exports). All exports run asynchronously via Django-Q and report progress through a report_id-based task update stream that the UI polls.",
        "key_responsibilities": [
          "Start single-project export zip creation as an async Django-Q task and redirect to a monitor page",
          "Provide JSON polling endpoints that return task update messages and a derived status (unknown/finished/error)",
          "Render monitor and completion templates for export workflows, including optional S3 presigned download URLs for project zips",
          "Run admin-only bulk source exports: generate per-project source.zip + metadata.json and batch index/failures summaries",
          "Run admin-only bulk audio exports: copy audio files grouped by (engine_id, language_id, voice_id) and write per-group manifests plus batch summaries",
          "Provide helper utilities for clearing output directories and computing SHA-256 checksums for exported artifacts"
        ],
        "potential_issues": [
          "Status detection is message-substring based (e.g., any message containing \"error\"), which can misclassify status if unrelated text includes that substring; single-project status checks for exact membership ('error' in messages) while bulk checks substring, leading to inconsistent behavior.",
          "make_export_zipfile_status prints to stdout on every poll, which can spam logs in production and leak operational details.",
          "start_bulk_source_exports passes dest_root through the URL and later uses it directly as a filesystem path; this can be risky if URL routing allows arbitrary paths (path traversal / unexpected locations) and should be validated/normalized server-side.",
          "bulk_audio_export_complete ignores any custom output root (it always reads $CLARA/tmp/bulk_audio_exports), so the completion page may not reflect where the task actually wrote data if that ever becomes configurable.",
          "export_all_project_zips_task converts QuerySets to Python lists when applying only_ids/skip_ids, which can load all projects into memory and be slow on large databases; filtering should ideally be done at the database level.",
          "Bulk source export always writes failures.json (even empty), while bulk audio export writes failures.json only on failures; downstream tooling should not assume consistent presence.",
          "export_all_project_zips_task reads the generated zip into memory (read_bytes/write_bytes) before writing to destination; large zips could cause high memory usage and should be streamed/copied instead.",
          "_clear_dir suppresses all exceptions silently, which can leave partial state without reporting; tasks may claim success while output directories were not actually cleared."
        ]
      }
    },
    {
      "created_at": "2025-12-22T12:20:18.331671+00:00",
      "model": "gpt-5.1-codex-max",
      "usage": {
        "model": "gpt-5.1-codex-max",
        "prompt_tokens": 5529,
        "completion_tokens": 1912,
        "total_tokens": 7441,
        "estimated_cost_usd": 0.026031250000000002
      },
      "analysis": {
        "proposed_docstring": "Views for packaging and exporting C-LARA content into portable bundles. This module drives three asynchronous workflows: single-project export zips for project members, bulk source exports of all projects, and bulk audio exports of repository content. It wires up start/monitor/status/complete pages, dispatches long-running tasks via django-q, streams progress via task updates, and writes manifest/index files alongside the exported archives.",
        "short_summary": "This views module orchestrates creation of export bundles for C-LARA projects and audio. It provides protected endpoints to kick off async packaging jobs, polls task updates, and renders monitor/complete pages. Bulk exports iterate over all projects or audio metadata, write out zips and manifests, and record index/failure summaries.",
        "key_responsibilities": [
          "Initiate single-project export zip creation with role-guarding, enqueue async tasks, and render status/complete pages with optional S3 presigned download links.",
          "Provide admin-only bulk source export flow: collect filters, start a background job to zip each project into a directory tree, and summarize successes/failures.",
          "Provide admin-only bulk audio export flow: copy repository audio grouped by engine/language/voice, emit manifests and index files, and report outcomes.",
          "Expose JSON status endpoints that poll task updates and derive simple finished/error/unknown states for front-end monitors."
        ],
        "potential_issues": [
          "Single-project status detection checks for exact 'error' or 'finished' messages; non-exact error texts may leave status 'unknown'.",
          "Bulk status endpoints flag any message containing 'error', which may produce false positives on benign messages mentioning errors.",
          "bulk_audio_export_complete reads from a hardcoded CLARA tmp path; if export destinations ever become configurable, summaries may point to the wrong directory.",
          "Destination roots for bulk source exports are passed via URL parameters; although admin-only, unvalidated paths could expose or clobber arbitrary directories.",
          "_clear_dir silently ignores deletion errors, which can leave stale files and ambiguous results on subsequent runs."
        ]
      }
    }
  ]
}