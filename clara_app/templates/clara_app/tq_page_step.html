{% extends "clara_app/base.html" %}
{% block content %}
{% load dict_extras %}

<h4>{{ tq.title }} â€” page {{ page }} / {{ total_pages }}</h4>

{# Image (served via coherent_images route) #}
{% if image_relpath %}
  <img
    src="{% url 'serve_coherent_images_v2_file' link.book.project.id image_relpath %}"
    alt="Page image"
    style="max-width: 400px; margin-bottom: 0.5rem;"
  >
{% endif %}

{# Rendered page HTML in its special environment #}
<div class="clara-qpage">
  {{ html_snippet|safe }}
</div>

<form method="post">
  {% csrf_token %}
  <input type="hidden" name="phase" value="page">
  <input type="hidden" name="page" value="{{ page }}">

{% for idx, qtext in page_questions %}
  <p><strong>{{ qtext }}</strong></p>
  {% with prev=existing|get_item:idx %}
    {% for _ in "12345" %}
      <label class="mr-2">
        <input type="radio"
               name="q_pg_{{ idx }}"
               value="{{ forloop.counter }}"
               {% if prev == forloop.counter %}checked{% endif %}>
        {{ forloop.counter }}
      </label>
    {% endfor %}
  {% endwith %}
  <hr>
{% endfor %}

  {% if page < total_pages %}
    <button class="btn btn-primary">Save & Next</button>
  {% else %}
    <button class="btn btn-success">Save & Continue to overall questions</button>
  {% endif %}
</form>

{% endblock %}

