{% extends "clara_app/base.html" %}
{% load static %}

{% block content %}
<h2>{{ tq|default_if_none:"Create" }} Questionnaire</h2>

<form method="post">
  {% csrf_token %}
  {% if form.errors %}
  <div class="alert alert-danger">
    {{ form.non_field_errors }}
    {% for field in form.visible_fields %}
      {% for error in field.errors %}
         <p><strong>{{ field.label }}:</strong> {{ error }}</p>
      {% endfor %}
    {% endfor %}
  </div>
  {% endif %}

  <!-- meta fields -->
  <div class="form-group">
    {{ form.title.label_tag }} {{ form.title }}
  </div>
  <div class="form-group">
    {{ form.description.label_tag }} {{ form.description }}
  </div>

  {% if tq %}
    <h5>Books in questionnaire ({{ links|length }})</h5>
    <table class="table table-sm table-bordered">
      <tr><th>#</th><th>Title</th><th>L2</th></tr>
      {% for link in links %}
      <tr id="row-{{ link.id }}">
        <td>{{ forloop.counter }}</td>
        <td>{{ link.book.title }}</td>
        <td>{{ link.book.l2 }}</td>
      </tr>
      {% endfor %}
    </table>
  {% endif %}

  <div id="hiddenBookInputs"></div>

  <!-- whole-book questions -->
  <div class="form-group mt-3">
    {{ form.questions.label_tag }}
    {{ form.questions }}
    <small class="form-text text-muted">{{ form.questions.help_text }}</small>
  </div>

  <!-- per-page questions -->
  <div class="form-group mt-3">
    {{ form.per_page_questions.label_tag }}
    {{ form.per_page_questions }}
    <small class="form-text text-muted">{{ form.per_page_questions.help_text }}</small>
  </div>

  <button type="submit" name="save" class="btn btn-primary">Save questionnaire</button>
  <a href="{% url 'tq_my_list' %}" class="btn btn-secondary">Back</a>
</form>

<!-- collapsible picker -->
<button class="btn btn-outline-secondary mb-2" type="button"
        data-toggle="collapse" data-target="#pickerCollapse" aria-expanded="false">
  Add / Remove Books
</button>
<div class="collapse" id="pickerCollapse">
  {{ book_picker|safe }}
</div>

<script>
  // carry checked/unchecked ids
  document.querySelector("form").addEventListener("submit", () => {
    const dest  = document.getElementById("hiddenBookInputs");
    dest.innerHTML = "";
    const checked   = [];
    const unchecked = [];
    document.querySelectorAll("input[name='book_ids']").forEach(cb => {
      (cb.checked ? checked : unchecked).push(cb.value);
    });
    checked.forEach(id =>
      dest.insertAdjacentHTML("beforeend",
        `<input type="hidden" name="book_ids_checked" value="${id}">`));
    unchecked.forEach(id =>
      dest.insertAdjacentHTML("beforeend",
        `<input type="hidden" name="book_ids_unchecked" value="${id}">`));
  });

  // keep picker open when linked with #pickerCollapse
  document.addEventListener("DOMContentLoaded", () => {
    if (location.hash === "#pickerCollapse") {
      const el = document.getElementById("pickerCollapse");
      if (!el) return;
      if (typeof bootstrap !== "undefined" && bootstrap.Collapse) {
        new bootstrap.Collapse(el, { toggle: true });
      } else {
        el.classList.add("show");
      }
    }
  });
</script>
{% endblock %}
